/*!
 * angular-ra-brightcove.js v0.0.1
 * https://github.com/red-ant/angular-ra-brightcove
 */
!function(){angular.module("ra.brightcove",[]).provider("raBrightcove",function(){var a={},b=function(b){return angular.isObject(b)?void angular.extend(a,b):a};this.options=b,this.$get=function(){return{options:b}}}).directive("brightcove",["$window","$timeout","$interpolate","raBrightcove",function(a,b,c,d){var e=d.options();if(!e.player_id||!e.player_key)throw new Error("You need to set a player_id and player_key with the raBrightcoveProvider");return a.BCL={onBrightcoveTemplateLoaded:function(a){var b=$("[data-player-id="+a+"]").scope();b&&b.$apply(function(){b.brightcove_api.setPlayer()})},onBrightcoveTemplateReady:function(a){var b=$("[data-player-id="+a.target.experience.id+"]").scope();b&&b.$apply(function(){b.template_ready=!0})}},{restrict:"EA",transclude:!0,templateUrl:"/assets/brightcove/_brightcove.html",scope:{id:"=?",category:"@",scheduled:"@",playlist_id:"=playlistId",playlist_data:"=playlistData",video_still:"@videoStill",auto_start:"@autoStart"},controller:["$scope",function(a){this.play=function(){a.$broadcast("raBrightcove:play")},this.setVideoId=function(b,c){var d=a.current_id!==b;d&&(a.current_id=b,a.$broadcast("raBrightcove:change")),c&&this.play()},this.setVideoStill=function(b){a.current_video_still=b},this.setVideoTemplateReady=function(b){a.video_template_ready=b},this.setType=function(b){var c=["video","playlist","video-still"];a.type=_.contains(c,b)?b:c[0]},this.reinitAPI=function(){a.template_ready=!1,a.brightcove_api.init()}}],link:function(d,f,g,h){d.brightcove_api={id:void 0,player:void 0,player_type:void 0,modules:{},init:function(a){angular.isDefined(a)&&(this.id=a),this.id&&d.video_template_ready===!0&&b(this.setHTML.bind(this)).then(this.createExperiences.bind(this,300))},setHTML:function(){if(!(d.current_id&&"video"===this.player_type||!d.current_id&&"api"===this.player_type)){this.player_type=d.current_id?"video":"api";var a=f.find(".BrightcoveExperience").get(0),b='<object id="myExperience{{ brightcove_api.id }}" class="BrightcoveExperience"><param name="bgcolor" value="#FFFFFF"><param name="width" value="100%"><param name="height" value="100%"><param name="playerID" value="'+e.player_id+'" /><param name="playerKey" value="'+e.player_key+'" /><param name="isVid" value="true"><param name="isUI" value="true"><param name="dynamicStreaming" value="true"><param name="htmlFallback" value="true"><param name="wmode" value="opaque"><param name="autoStart" value="{{ auto_start || false }}"><param name="includeAPI" value="true"><param name="secureConnections" value="{{ ssl }}"><param name="secureHTMLConnections" value="{{ ssl }}" /><param name="videoSmoothing" value="false" /><param name="templateLoadHandler" value="BCL.onBrightcoveTemplateLoaded"><param name="templateReadyHandler" value="BCL.onBrightcoveTemplateReady">';"video"===this.player_type&&(b+='<param name="@videoPlayer" value="{{ current_id }}">'),b+="</object>",a&&(a.outerHTML=c(b)(d))}},setPlayer:function(){d.brightcove_api.player=a.brightcove.api.getExperience("myExperience"+this.id)},setModules:function(){angular.isDefined(d.brightcove_api.player)&&(d.brightcove_api.modules.experience=d.brightcove_api.player.getModule(a.brightcove.api.modules.APIModules.EXPERIENCE),d.brightcove_api.modules.video_player=d.brightcove_api.player.getModule(a.brightcove.api.modules.APIModules.VIDEO_PLAYER),d.brightcove_api.modules.cue_points=d.brightcove_api.player.getModule(a.brightcove.api.modules.APIModules.CUE_POINTS),d.brightcove_api.modules.content=d.brightcove_api.player.getModule(a.brightcove.api.modules.APIModules.CONTENT))},createExperiences:function(b){return a.brightcove=a.brightcove||{createExperiences:angular.noop},_.debounce(a.brightcove.createExperiences,b||0)()},isSSL:function(){return"https:"===a.location.protocol}},d.dimension={width:0,height:0,window_size:void 0,update:function(){var a,b,c,e,g=f.find("[brightcove-video]"),h=g.parents(".brightcove-video-container");h.get(0)||(h=f.parent()),e=h.css("width"),a=h.css({width:"auto"}).width()/16,b=16*Math.floor(a),c=9*Math.floor(a),b>0&&c>0&&this.width!==b&&this.height!==c?(this.height=c,this.width=b,h.css({width:b}),d.brightcove_api.modules.experience&&d.brightcove_api.modules.experience.setSize&&d.brightcove_api.modules.experience.setSize(this.width,this.height)):h.css({width:e})},onResize:function(){this.update()},autoResize:function(){var b=this;b.window_size||(b.window_size={},$(a).resize(_.debounce(function(){var a={width:$(window).width(),height:$(window).height()};(b.window_size.width!==a.width||b.window_size.height!==a.height)&&d.$apply(function(){b.onResize.apply(b,arguments)}),b.window_size.width=a.width,b.window_size.height=a.height},300)))},init:function(){d.$on("raBrightcove:resize",this.onResize.bind(this)),d.$on("tab:change",this.onResize.bind(this)),this.autoResize(),b(this.update.bind(this),300)}},d.listeners={template_ready:function(a){a&&(d.brightcove_api.setModules(),d.dimension.update(),d.$broadcast("raBrightcove:templateReady"))},video_still:function(a){a&&(h.setVideoStill(a),d.dimension.update())},id:function(a){angular.isDefined(a)&&(h.setVideoId(a),d.brightcove_api.init(a))},playlist_id:function(a){angular.isDefined(a)&&d.brightcove_api.init(a)},video_template_ready:function(a){a&&d.brightcove_api.init(d.brightcove_api.id)}},d.init=function(){d.ssl=d.brightcove_api.isSSL(),h.setType(g.type||(angular.isDefined(g.playlistId)?"playlist":"video")),d.dimension.init(),d.$watch("template_ready",d.listeners.template_ready),d.$watch("video_still",d.listeners.video_still),d.$watch("video_template_ready",d.listeners.video_template_ready),angular.isDefined(g.id)?d.$watch("id",d.listeners.id):d.$watch("playlist_id",d.listeners.playlist_id)},d.init()}}}]).directive("brightcovePlaylist",["$window","$timeout",function(a,b){return{restrict:"EA",require:"^brightcove",templateUrl:"/assets/brightcove/_playlist.html",scope:!0,link:function(c,d,e,f){c.playlist={element:d.find(".brightcove-playlist"),width:void 0,height:void 0,data:void 0,expanded:!1,expand_button:{height:35,visible:!1,toggle:function(a){c.playlist.expanded=angular.isUndefined(a)?!c.playlist.expanded:a,b(function(){c.playlist.element.hide(),c.playlist.element.offset(),c.playlist.element.show()})}},get:function(){c.$watch("playlist_data",this.set.bind(this))},set:function(){this.data=c.playlist_data,this.cue(),this.updateDimension()},updateDimension:function(){c.dimension&&this.data?b(this.updateDimensionWithData.bind(this)):c.dimension&&!this.data&&(this.height=c.dimension.height,this.expand_button.visible=!1)},updateDimensionWithData:function(){var a=c.dimension.height,b=_.last(this.data.items);this.isChildVisible(b.id)?(this.height=a,this.expand_button.visible=!1):(this.height=a-this.expand_button.height,this.expand_button.visible=!0)},cue:function(){var b=this,d=this.data,e=d.items[0];e&&!c.id&&(f.setVideoId(e.id),f.setVideoStill(e.videoStillURL),f.reinitAPI()),c.brightcove_api.modules.video_player.addEventListener(a.brightcove.api.events.MediaEvent.COMPLETE,function(){var a=_.find(d.items,{id:c.current_id}),e=_.indexOf(d.items,a),g=e+1,h=d.items[g];g<d.items.length&&c.$apply(function(){f.setVideoId(h.id,!0),f.setVideoStill(h.videoStillURL),b.isChildVisible(h.id)||b.scrollTo(h.id,-30)})})},scrollTo:function(a,b){var c=this.getChild(a).position();c&&c.top&&this.element.animate({scrollTop:"+="+(c.top+b)})},isChildVisible:function(a){var b=this.getChild(a),d=b.position(),e=c.dimension.height||this.element.height();return d&&angular.isDefined(d.top)?d.top>=0&&d.top<=e-b.innerHeight():void 0},getChild:function(a){return this.element.find("[data-id="+a+"]").eq(0)},play:function(a){f.setVideoId(a,!0)},init:function(){this.element.css({position:"relative"}),this.get()}},c.init=function(){c.$on("raBrightcove:templateReady",function(){c.playlist.init()}),c.$watch("dimension.height",function(){c.playlist.updateDimension()})},c.init()}}}]).directive("brightcoveVideo",["$window","$location","$timeout","$rootScope",function(a,b,c){return{restrict:"EA",require:"^brightcove",templateUrl:"/assets/brightcove/_video.html",scope:!0,link:function(b,d,e,f){b.video={is_playing:!1,is_played:!1,started_playing:!1,completed_playing:!1,position:void 0,duration:void 0,rendition:void 0,timeout_count:0,play:function(a){angular.isUndefined(b.brightcove_api.modules.video_player)||!b.current_id?this.timeout_count<10&&c(function(){this.play(a),this.timeout_count++}.bind(this),500):(d.show(),this.is_playing=!0,this.is_played=!0,this.started_playing=!0,b.alerts.init(),Video.increment.show({id:a||b.current_id}),b.brightcove_api.modules.video_player.loadVideoByID(angular.isDefined(a)?a:b.current_id))},get:function(){var a=this;b.brightcove_api.modules.video_player.getCurrentVideo(function(c){b.$apply(function(){a.set(c)})})},reset:function(){this.is_playing=!1,this.is_played=!1,this.started_playing=!1,this.completed_playing=!1,this.position=void 0,this.duration=void 0,this.timeout_count=0},set:function(a){angular.isObject(a)&&(this.data=a,(!b.video_still||b.video_still.match("missing"))&&f.setVideoStill(a.videoStillURL))},listenAPI:function(){if(b.brightcove_api.modules.video_player){var c=this;b.brightcove_api.modules.video_player.addEventListener(a.brightcove.api.events.MediaEvent.STOP,function(){b.$apply(function(){b.video.is_playing=!1})}),b.brightcove_api.modules.video_player.addEventListener(a.brightcove.api.events.MediaEvent.PLAY,function(){b.$apply(function(){b.video.is_playing=!0})}),b.brightcove_api.modules.video_player.addEventListener(a.brightcove.api.events.MediaEvent.COMPLETE,function(){b.$apply(function(){b.video.completed_playing=!0})}),b.brightcove_api.modules.video_player.addEventListener(a.brightcove.api.events.MediaEvent.PROGRESS,function(a){b.$apply(function(){b.video.position=a.position,b.video.rendition=a.rendition})}),b.brightcove_api.modules.video_player.getVideoDuration(!1,function(a){b.$apply(function(){b.video.duration=a})}),b.brightcove_api.modules.video_player.addEventListener(a.brightcove.api.events.MediaEvent.CHANGE,function(){b.$apply(function(){c.get()})})}},listen:function(){var a=this;b.$on("raBrightcove:play",function(){a.play(b.current_id)}),b.$on("raBrightcove:change",function(){a.reset()})},init:function(){this.listen(),this.listenAPI()}},b.alerts={rendition:void 0,Alert:function(){function a(a){this.type=a,this.visible=!1,this.storage=raStorage("brightcove_alert_"+a),this.init()}return a.prototype={init:function(){"rendition"===this.type&&!this.storage.get("closed")&&b.video.is_played&&"flash"===b.brightcove_api.player.type&&(this.visible=!0)},show:function(){this.visible=!0},close:function(a){this.visible=!1,a&&this.storage.set("closed",!0)}},a}(),create:function(a){return new this.Alert(a)},init:function(){this.rendition=this.create("rendition")}},b.init=function(){f.setVideoTemplateReady(!0),b.video.init(),b.$on("raBrightcove:templateReady",function(){b.video.get()})},b.init()}}}]).directive("brightcoveVideoStill",function(){return{require:"^brightcove",templateUrl:"/assets/brightcove/_video-still.html",link:function(a,b,c,d){a.video_still={get:function(){a.brightcove_api.modules.video_player.getCurrentVideo(function(b){a.$apply(function(){d.setVideoStill(b.videoStillURL)})})},init:function(){this.get()}},a.init=function(){d.setVideoTemplateReady(!0),a.$on("raBrightcove:templateReady",function(){a.video_still.init()})},a.init()}}}).directive("videoDimensions",["$timeout",function(a){function b(b){a(function(){b.height(Math.round(9*b.width()/16)),c(b)})}function c(a){"iframe"===a.prop("tagName").toLowerCase()&&angular.isDefined(a.attr("src"))&&a.attr({src:a.attr("src")})}return{restrict:"A",link:function(a,c,d){angular.isDefined(d.videoDimensionsWatch)?a.$watch(d.videoDimensionsWatch,function(a){angular.isDefined(a)&&b(c)}):b(c)}}}]).directive("cuepoints",["$window","$timeout",function(a,b){return{restrict:"EA",replace:!0,require:"^brightcove",templateUrl:"/assets/brightcove/_cuepoints.html",link:function(c,d,e,f){function g(){i.removeEventListener(a.brightcove.api.events.MediaEvent.PROGRESS,g),i.seek(c.queued_time)}var h,i;c.templateReadyWatch=function(d){if(d&&(h=c.brightcove_api.player,i=c.brightcove_api.modules.video_player,i&&$("#myExperience"+c.brightcove_api.id).get(0))){var e={progress:"progress",play:"play",stop:"stop",seek:"seek_notify"};_.each(e,function(d,e){i.addEventListener(a.brightcove.api.events.MediaEvent[d.toUpperCase()],function(a){e=e.charAt(0).toUpperCase()+e.slice(1),e="onVideo"+e,angular.isFunction(c[e])&&b(function(){c[e](a)})})}),i.addEventListener(a.brightcove.api.events.CuePointEvent.CUE,function(a){b(function(){c.onVideoCuePoint(a)})}),i.getVideoDuration(!1,function(a){b(function(){c.duration=a})}),c.getCuePoints(),c.templateReadyWatcher()}},c.seek=function(){var b=this.chapter;i.getIsPlaying(function(d){d===!0?(i.seek(b.time),c.time=b.time,c.startTimer(b.time),c.updateChapters(b.time)):(c.queued_time=b.time,c.time=b.time,i.addEventListener(a.brightcove.api.events.MediaEvent.PROGRESS,g),f.play())})},c.onVideoProgress=function(){},c.onVideoPlay=function(a){a&&(c.time=a.position,c.updateChapters(a.position),c.startTimer(a.position))},c.onVideoStop=function(){c.stopTimer()},c.onVideoSeek=function(a){a&&(c.time=a.position,c.updateChapters(a.position),c.updateProgress(a.position))},c.onVideoCuePoint=function(a){a&&(c.time=a.cuePoint.time,c.updateChapters(a.cuePoint.time),c.$emit("raBrightcove:cuepoint",a.cuePoint))},c.clearTimer=function(){c.timer&&b.cancel(c.timer)},c.startTimer=function(){c.clearTimer(),c.timer=b(function(){c.time=c.time+.5,c.updateProgress(),c.startTimer()},500)},c.stopTimer=function(){c.clearTimer()},c.updateProgress=function(){var a=c.chapters[c.current_chapter];if(a){var b=Math.round(1e4*(c.time-a.time)/a.length)/100;c.chapters[c.current_chapter].progress_width=b}},c.updateChapters=function(a){var b=!1;_.each(c.chapters,function(d,e){a<d.end_time?(b===!1?(b=!0,c.current_chapter=e,d.active=!0):(d.active=!1,d.progress_width=0),d.past=!1):(d.active=!1,d.past=!0,d.progress_width=100)})},c.populateChapters=function(){var a=c.duration;_.each(c.cuepoints,function(b,d){var e=c.cuepoints[d+1];e?(b.length=e.time-b.time,b.end_time=e.time):(b.length=a-b.time,b.end_time=a)}),c.chapters=_.filter(c.cuepoints,function(b){return 1===b.type&&"Pre-roll"!==b.name&&"Post-roll"!==b.name?!0:(a-=b.length,!1)}),_.each(c.chapters,function(b){b.width=1e4*b.length/a/100;var c=Math.floor(b.length/60),d=Math.round(b.length%60);b.duration=c+":"+d,b.content="<p><b>"+b.name+"</b></p>",b.content+="<p>Duration: "+b.duration+"</p>",b.metadata&&(b.content+="<p>"+b.metadata+"</p>")})},c.getCuePoints=function(){c.brightcove_api.modules.cue_points.getCuePoints(c.current_id,function(a){b(function(){c.getCuePointsSuccess(a)})})},c.getCuePointsSuccess=function(a){c.cuepoints=a,c.populateChapters(),c.$emit("raBrightcove:cuepointsLoaded",c.current_id,a)},c.init=function(){c.templateReadyWatcher=c.$watch("template_ready",c.templateReadyWatch)},c.init()}}}])}();